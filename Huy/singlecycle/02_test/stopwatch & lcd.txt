    

# =====================================================
#  RV32I LCD 4-bit demo (no pseudoinstructions)
#  MMIO @ 0x10004000
#    bit31 LCD_ON, bit10 EN, bit9 RS, bit8 RW, bit7..0 DATA
#  Manual CALL/RET via x2 (return stack) storing PC words
# =====================================================

# =====================================================
#  Thanh Ghi sử dung:
# x1  = Address Pointer
# x2  = Manual Stack Address Pointer
# x3  = MMIO  LCD (0x10004000)
# x5  = delay value / 100us
# x20 = LCD_ON bit mask (bit 31)
# x21 = EN     bit mask (bit 10)
# x22 = RS     bit mask (bit 9)
# x23 = RW     bit mask (bit 8)
# x24 = D0-7   bit mask (bit 0-7)
# x25 = LCD DATA (General Purpose)
# x26 = clear data bit mask
# =====================================================
    # x2 = manual return stack pointer
    addi  x2, x0, 0

    # jump to main
    jal   x0, main

# ======================================
# MAIN FUNCTION
# ======================================
main:
    # x3 = LCD MMIO address
    lui   x3, 0x10004       # => 0x10004000

    # x20 = LCD_ON bit mask (bit 31)
    # x21 = EN     bit mask (bit 10)
    # x22 = RS     bit mask (bit 9)
    # x23 = RW bit mask (bit 8)
    lui   x20, 0x80000      # => 0x80000000
    addi  x21, x0, 0x400    # => 0x00000400
    addi  x22, x0, 0x200    # => 0x00000400
    addi  x23, x0, 0x100    # => 0x00000400
    addi  x26, x0, -256     # => 0xffffff00

    # ------------------------------------------------
    # Bật LCD
    # ------------------------------------------------
    add   x25, x0, x0        # Reset x25
    xor   x25, x0, x20       # LCD_ON=1
    sw    x25, 0(x3)         # LCD_ON=1, EN=0, RS=0, RW=0, data=0
 
    # delay ~20ms
    addi  x5, x0, 200
    jal   x1, delay_100us

    # ------------------------------------------------
    #   lcd_power_reset_8:
    # ------------------------------------------------
	# Command 30h 1st
	and x25, x25, x26
	ori x25, x25, 0x30
	jal x1, lcd_out
	addi x5, x0, 41		# delay 4.1ms
	jal x1, delay_100us


	# Command 30h 2st
	and x25, x25, x26
	ori x25, x25, 0x30
	jal x1, lcd_out
	addi x5, x0, 2		# delay 200us
	jal x1, delay_100us


	# Command 30h 3st
	and x25, x25, x26
	ori x25, x25, 0x30
	jal x1, lcd_out
	addi x5, x0, 2		# delay 200us
	jal x1, delay_100us


    # ------------------------------------------------
    # lcd_init
    # RS = 0
    # ------------------------------------------------

	# 8 bit, 2 dòng, font 5x8
	and x25, x25, x26
	ori x25, x25, 0x38	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us


	# Clear Display
	and x25, x25, x26
	ori x25, x25, 0x01	
	jal x1, lcd_out
	addi x5, x0, 20		# delay 2ms
	jal x1, delay_100us


	# màn hình on, con trỏ off
	and x25, x25, x26
	ori x25, x25, 0x0C	 
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us


	# dịch phải con trỏ, địa chỉ DDRAM tăng 1 khi ghi data
	and x25, x25, x26
	ori x25, x25, 0x06	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us



    # ------------------------------------------------
    # In chuỗi "HELLO"
    # RS = 1
    # ------------------------------------------------

	or x25, x25, x22	# RS = 1

	# T
	and x25, x25, x26
	ori x25, x25, 0x54	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

   	# H
	and x25, x25, x26
	ori x25, x25, 0x48	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

    	# E
	and x25, x25, x26
	ori x25, x25, 0x45	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

    	# 
	and x25, x25, x26
	ori x25, x25, 0x20	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

   	# 3
 	and x25, x25, x26
	ori x25, x25, 0x33	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# 
	and x25, x25, x26
	ori x25, x25, 0x20	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# M
	and x25, x25, x26
	ori x25, x25, 0x4d	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# U
	and x25, x25, x26
	ori x25, x25, 0x55	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# S
	and x25, x25, x26
	ori x25, x25, 0x53	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# K
	and x25, x25, x26
	ori x25, x25, 0x4B	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# E
	and x25, x25, x26
	ori x25, x25, 0x45	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# T
	and x25, x25, x26
	ori x25, x25, 0x54	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# E
	and x25, x25, x26
	ori x25, x25, 0x45	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# E
	and x25, x25, x26
	ori x25, x25, 0x45	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# R
	and x25, x25, x26
	ori x25, x25, 0x52	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

	# S
	and x25, x25, x26
	ori x25, x25, 0x53	
	jal x1, lcd_out
	addi x5, x0, 1		# delay 100us
	jal x1, delay_100us

    # ------------------------------------------------
    # Infinite loop
    # ------------------------------------------------
infinite_loop:
    jal x0, stopwatch





# =========================
#   lcd_out:
#   x25 = data, toggle E to print
#   Default E = 0
# =========================
lcd_out:
	or  x25, x25, x21	# E = 1
	sw    x25, 0(x3)

	# delay  450ns
	addi x0, x0, 0		# NOP (40ns)
	addi x0, x0, 0		# NOP
	addi x0, x0, 0		# NOP
	addi x0, x0, 0		# NOP

	addi x0, x0, 0		# NOP
	addi x0, x0, 0		# NOP
	addi x0, x0, 0		# NOP
	addi x0, x0, 0		# NOP

	addi x0, x0, 0		# NOP
	addi x0, x0, 0		# NOP
	addi x0, x0, 0		# NOP
	addi x0, x0, 0		# NOP (480ns)


	xor x25, x25, x21	# E = 0
	sw    x25, 0(x3)

    jalr  x0, x1, 0		# Return



# =========================
#   delay_100us:
#   x5 = count, mỗi vòng ~100µs @ 25 MHz
# =========================
delay_100us:
    # Outer loop over x5
delay_100us_loop:
    addi  x7, x0, 1249		# N ≈ (25e6*100e-6 - 3)/2 = 1249
dly_inner:
    addi  x7, x7, -1
    bne   x7, x0, dly_inner

    addi  x5, x5, -1
    bne   x5, x0, delay_100us_loop

    jalr  x0, x1, 0

stopwatch:
    li x0, 0
    li x1, 0
    li x2, 0
    li x3, 0
    li x4, 0
    li x7, 0
    li x8, 0
    li x9, 0
    li x11, 0
    li x12, 0
    li x13, 0
    li x14, 0
    li x15, 0
    li x16, 0
    li x17, 0
    li x18, 0
    li x19, 0
    li x20, 0
    li x21, 0
    li x22, 0
    li x23, 0
    li x24, 0
    li x25, 0
    li x26, 0
    li x27, 0
    li x28, 0
    li x29, 0
    li x30, 0
    li x31, 0
 
    li x5, 0x10002000       # địa chỉ LED
    li x6, 0x10010000       # địa chỉ SW
    li x10, 0x1             # detect KEY[0]
    li x7, 0
    li x13, 0x1771          # 0110_0000_0000_0001 = 60:01

main_loop:
    jal x2, add1tohex
    jal x0, main_loop
    
# ---------------------------------
# delay1s:
# ---------------------------------
delay1s:
    li x3, 0
    li x4, 0x3F940B   # ~1s @25MHz
delay_loop:
    jal x18, detectkey
    addi x3, x3, 1
    bne  x3, x4, delay_loop
    jalr x0, x1, 0

# ---------------------------------
# add1to9tohexled:
# ---------------------------------
add1tohex:
    addi x7, x7, 1
    jal x14, bin2bcd
    sw x8, 0(x5)
    jal x1, delay1s
    blt x7, x13, add1tohex
    jalr x0, x2, 0
    
# ---------------------------------
# detectkey:
# ---------------------------------
detectkey:
    lw x9, 0(x6)
    bne x9, x10, detectkey
    jalr x0, x18, 0

# ---------------------------------
# bin2bcd:
# ---------------------------------
bin2bcd:
    # Load sẵn giá trị 5 vào x29 để so sánh
    li   x29, 5
    # Load giá trị cmp 
    # li   x27, 128
    li   x26, 8
    # Số vòng lặp
    li   x28, 17
    # Lấy value từ x7
    # li      x7, 6001
    ori     x30, x7, 0
    slli    x30, x30, 16

    # Initialize 4 registers x20, x21, x22, x23
    # x20, x21 for seconds; x22, x23 for minute
    addi x20, x0, 0
    addi x21, x0, 0
    addi x22, x0, 0
    addi x23, x0, 0
    
    start_convert:
    addi    x28, x28, -1
    beq     x28, x0, end_convert
    
    loop_convert:
    shift_x23:
    slli    x23, x23, 1
    andi    x23, x23, 0x00f
    bltu    x22, x26, shift_x22
    ori     x23, x23, 1
    shift_x22:
    slli    x22, x22, 1
    andi    x22, x22, 0x00f
    bltu    x21, x26, shift_x21
    ori     x22, x22, 1
    shift_x21:
    slli    x21, x21, 1
    andi    x21, x21, 0x00f
    bltu    x20, x26, shift_x20
    ori     x21, x21, 1
    shift_x20:
    slli    x20, x20, 1
    andi    x20, x20, 0x00f
    bge     x30, x0,  add5
    ori     x20, x20, 1
    add5:
    add5_x23:
    bltu    x23, x29, add5_x22
    addi    x23, x23, 3
    add5_x22:
    bltu    x22, x29, add5_x21
    addi    x22, x22, 3
    add5_x21:
    bltu    x21, x29, add5_x20
    addi    x21, x21, 3
    add5_x20:
    bltu    x20, x29, shift_x30
    addi    x20, x20, 3
    
    shift_x30:
    slli    x30, x30, 1
    jal     x16, start_convert
    
    end_convert:
    sub3_x23:
    bltu    x23, x29, sub3_x22
    addi    x23, x23, -3
    sub3_x22:
    bltu    x22, x29, sub3_x21
    addi    x22, x22, -3
    sub3_x21:
    bltu    x21, x29, sub3_x20
    addi    x21, x21, -3
    sub3_x20:
    bltu    x20, x29, final_result
    addi    x20, x20, -3
    
    final_result:
    and     x8, x8, x0
    or      x8, x8, x23
    slli    x8, x8, 4
    or      x8, x8, x22
    slli    x8, x8, 4
    or      x8, x8, x21
    slli    x8, x8, 4
    or      x8, x8, x20
    
    finish_bin2bcd:
    jalr    x0, x14, 0
